name: Full Pipeline Workflow

on:
  # ✅ Quando abrir PR para develop (feature → develop)
  pull_request:
    branches: [ "develop" ]

  # ✅ Quando fizer merge na develop
  push:
    branches: [ "develop" ]

  # ✅ Botões manuais para deploy
  workflow_dispatch:
    inputs:
      environment:
        description: "Escolha o ambiente para deploy"
        required: true
        type: choice
        options:
          - hml
          - master

jobs:

  # ✅ 1) Validação do PR (feature → develop)
  validate_pr:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate PR
        run: echo "Rodando validações do PR para develop..."

  # ✅ 2) Build quando mergeia na develop
  build_develop:
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/develop' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build app
        run: |
          echo "Build realizado para branch develop"
          # mvn clean package (exemplo real)
          echo "artefato gerado"

  # ✅ 3) Deploy manual para HML
  deploy_hml:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'hml' }}
    runs-on: ubuntu-latest
    environment: hml   # ✅ exige aprovação no GitHub
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to HML
        run: |
          echo "Realizando deploy para HML..."
          ./deploy-hml.sh || true

  # ✅ 4) Deploy manual para master (produção)
  deploy_prod:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'master' }}
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Production
        run: |
          echo "Realizando deploy para produção..."
          ./deploy-prod.sh || true
